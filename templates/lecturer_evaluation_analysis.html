<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Module Evaluation Analysis</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="evaluation_data" style="display:none;">
<div id="data_subsets">{{data.subsets}}</div>
<div id="data_overall">{{data.overall}}</div>
<div id="questions">{{question_titles|tojson}}</div>
<div id="modules">{{modules|tojson}}</div>
{% for module in data.modules %}
<div class="data_module" id="{{module.meta.code}}_data">{{module.data}}</div>
<div class="meta_module" id="{{module.meta.code}}_meta">{{module.meta_json}}</div>
{% endfor %}
{% for question in comparisons %}
<div class="lecturer_comparison" id="q_data_{{question.id}}">{{question.data}}</div>
{% endfor %}
    </div>

    <div class="page_a4">
        <section id="front_page">
            <h1>{{lecturer}} - Academic Year {{label}} (n = {{total|int}})</h1>
            <div id="teaching_evaluation">
                <div class="wrapper">
                    <div class="pie" id="pie_vis0">
                        <h3 class="pie_title"></h3>
                    </div>
                    <div class="pie" id="pie_vis1">
                        <h3 class="pie_title"></h3>
                    </div>
                    <div class="pie" id="pie_vis2">
                        <h3 class="pie_title"></h3>
                    </div>
                </div>
            </div>
            <h2>School Average Comparison</h2>
            <div id="comparison"></div>
        </section>
    </div>

    {% for question in comparisons %}
    <div class="page_a4">
        <div class="question">
            <h2>{{question.q}}</h2>
            <div class="vis" id="q_{{question.id}}"></div>
        </div>
    </div>
    {% endfor %}

    {% for module in data.modules %}
    <div class="page_a4">
        <section id="module-page">
            <h1>{{module.meta.code}} (n = {{module.meta.count|int}})</h1>
            <div id="teaching_evaluation">
                <div class="wrapper">
                    <div class="pie" id="{{module.meta.code}}_pie_vis0">
                        <h3 class="pie_title"></h3>
                    </div>
                    <div class="pie" id="{{module.meta.code}}_pie_vis1">
                        <h3 class="pie_title"></h3>
                    </div>
                    <div class="pie" id="{{module.meta.code}}_pie_vis2">
                        <h3 class="pie_title"></h3>
                    </div>
                </div>
            </div>
            <h2>School Average Comparison</h2>
            <div id="{{module.meta.code}}_comparison"></div>
        </section>
        {% if loop.last %}
        <section id="attribution">
            <footer>
                <p>
                <small>
                Generated by "module-evaluation-analysis" by <a href="http://www.martinjc.com">Martin Chorley</a> (<a href="https://www.twitter.com/martinjc">@martinjc</a>)<br>Code available at <a href="https://gitlab.cs.cf.ac.uk/comsc/module-review-analysis">https://gitlab.cs.cf.ac.uk/comsc/module-review-analysis</a> Licensed under the <a href="https://opensource.org/licenses/MIT">MIT Licence</a>. Pull requests always welcome.
                </small>
                </p>
            </footer>
        </section>
        {% endif %}
    </div>
    {% endfor %}

    <script src="evaluation_pie.js"></script>
    <script src="against_average.js"></script>
    <script src="overall_lecturer_analysis.js"></script>
    <script>
    (function() {

        var subset_data = d3.csvParse(d3.select('#data_subsets')
            .html());

        var module_data = d3.csvParse(d3.select('#data_overall')
            .html());

        var comparison_data = module_data.map(function(d, i) {
            var average = +subset_data.filter(function(a){
                return a.question === d.question;
            })[0]['All Lecturers'];
            return {
                'question': d.question.replace(': ', ''),
                'Agree': +d.Agree,
                'average': average,
                'diff': (+d.Agree) - (+average)
            }
        });

        var average_data = comparison_data.map(function(d){
            return {
                question: d.question,
                average: d.average
            }
        });

        var averages = [];
        school_average = {
            name: 'school_average',
            title: 'School Average',
            data: average_data,
            fill: '#4169e1',
            symbol: d3.symbol()
                .type(d3.symbolCross)
                .size(80),
        }
        averages.push(school_average);

        var chart = againstAverage()
            .width(1100)
            .height(300)
            .margin({
                top: 40,
                bottom: 20,
                left: 60,
                right: 200,
            })
            .averages(averages)
            .value_label('Average over all modules in this group');

        var container = d3.select("#comparison")
            .datum(comparison_data)
            .call(chart);

        var columns = module_data.columns.splice(1);

        module_data.forEach(function(d, i) {

            var chart = evaluationPie()
                .width(400)
                .height(250)
                .margin({
                    top: 20,
                    bottom: 40,
                    left: 120,
                    right: 120
                })
                .i(i)
                .columns(columns);

            var container = d3.select("#pie_vis" + i)
                .datum(d)
                .call(chart);

            container.select('h3')
                .html(d.question.replace(': ', ''));

        });

        var modules = JSON.parse(d3.select('#modules').html());

        modules.forEach(function(m){

            var this_module_data = d3.csvParse(d3.select('#' + m + '_data')
                .html());

            this_module_data.forEach(function(d, i) {
                var chart = evaluationPie()
                    .width(400)
                    .height(250)
                    .margin({
                        top: 20,
                        bottom: 40,
                        left: 120,
                        right: 120
                    })
                    .i(i)
                    .columns(columns);

                var container = d3.select("#" + m + "_pie_vis" + i)
                    .datum(d)
                    .call(chart);

                container.select('h3')
                    .html(d.question.replace(': ', ''));

            });
            var this_comparison_data = this_module_data.map(function(d, i) {
                var average = +subset_data.filter(function(a){
                    return a.question === d.question;
                })[0]['All Lecturers'];
                return {
                    'question': d.question.replace(': ', ''),
                    'Agree': +d.Agree,
                    'average': average,
                    'diff': (+d.Agree) - (+average)
                }
            });

            var chart = againstAverage()
                .width(1100)
                .height(300)
                .margin({
                    top: 40,
                    bottom: 20,
                    left: 60,
                    right: 200,
                })
                .averages(averages)
                .value_label('Module Score');

            var container = d3.select("#"+ m + "_comparison")
                .datum(this_comparison_data)
                .call(chart);
        });

        var questions = JSON.parse(d3.select('#questions').html());

        questions.forEach(function(q, i){
            var question_data = d3.csvParseRows(d3.select('#q_data_'+ i).html(), function(d){
                return {
                    lecturer: d[0],
                    value: +d[1]
                }
            });

            var average_value = subset_data.filter(function(d){
                return d.question === q;
            })[0]['All Lecturers'];

            question_data.forEach(function(d){
                d.average = +average_value;
                d.diff = d.value - (+average_value);
            });

            var container = d3.select('#q_' + i);

            var chart = horizontalRankingChart()
                .height(400)
                .average_value(+average_value);

            container
                .datum(question_data)
                .call(chart);
        });


    })();
    </script>
</body>
</html>
